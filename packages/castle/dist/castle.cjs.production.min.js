"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@ethersproject/bignumber");function e(){return(e=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(t[s]=r[s])}return t}).apply(this,arguments)}function r(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,o(t,e)}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function o(t,e){return(o=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function i(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function n(t,e,r){return(n=i()?Reflect.construct:function(t,e,r){var s=[null];s.push.apply(s,e);var i=new(Function.bind.apply(t,s));return r&&o(i,r.prototype),i}).apply(null,arguments)}function u(t){var e="function"==typeof Map?new Map:void 0;return(u=function(t){if(null===t||-1===Function.toString.call(t).indexOf("[native code]"))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,r)}function r(){return n(t,arguments,s(this).constructor)}return r.prototype=Object.create(t.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),o(r,t)})(t)}function a(t,e){!t()&&e&&console.error(e)}function c(t,e,r){return 0===r?t===e:t<1/r?Math.abs(t-e)<=10:Math.abs(t/e-1)<r}function h(t,e,r){void 0===r&&(r=1);try{if(e<=t(0))return 0;var s,o;if(t(r)>e){for(s=r/2;t(s)>e;)s/=2;o=2*s}else{for(o=2*r;t(o)<e;)o*=2;s=o/2}for(;o/s-1>1e-4;){var i=(s+o)/2,n=t(i);if(e===n)return i;e<n?o=i:s=i}return(s+o)/2}catch(t){return 0}}function v(e){var r=Math.abs(e);if(r<Number.MAX_SAFE_INTEGER)return t.BigNumber.from(Math.round(e));var s=Math.floor(Math.log(r)/Math.LN2);console.assert(s>=51,"Internal Error 314");var o=s-51,i=Math.round(r/Math.pow(2,o)),n=t.BigNumber.from(i).mul(t.BigNumber.from(2).pow(o));return e>0?n:n.mul(-1)}var p,d=function(){function t(t,e,r,s,o,i,n,u){void 0===n&&(n=1e3),void 0===u&&(u=4e4),this.address=t,this.token0=e,this.token1=r,this.fee=s,this.minLiquidity=n,this.swapGasCost=u,this.reserve0=o,this.reserve1=i}return t.prototype.updateReserves=function(t,e){this.reserve0=t,this.reserve1=e},t}(),l=function(t){function e(e,r,s,o,i,n){var u;return(u=t.call(this,e,r,s,o,i,n)||this).reserve0Number=parseInt(i.toString()),u.reserve1Number=parseInt(n.toString()),u}r(e,t);var s=e.prototype;return s.updateReserves=function(t,e){this.reserve0=t,this.reserve0Number=parseInt(t.toString()),this.reserve1=e,this.reserve1Number=parseInt(e.toString())},s.calcOutByIn=function(t,e){return{out:(e?this.reserve1Number:this.reserve0Number)*t/((e?this.reserve0Number:this.reserve1Number)/(1-this.fee)+t),gasSpent:this.swapGasCost}},s.calcInByOut=function(t,e){return{inp:(e?this.reserve0Number:this.reserve1Number)*t/(1-this.fee)/((e?this.reserve1Number:this.reserve0Number)-t),gasSpent:this.swapGasCost}},s.calcCurrentPriceWithoutFee=function(t){return this.calcPrice(0,t,!1)},s.calcPrice=function(t,e,r){var s=(e?this.reserve0Number:this.reserve1Number)/(r?1-this.fee:1);return(e?this.reserve1Number:this.reserve0Number)*s/(s+t)/(s+t)},s.calcInputByPrice=function(t,e,r){var s=(e?this.reserve0Number:this.reserve1Number)/(r?1-this.fee:1);return Math.sqrt((e?this.reserve1Number:this.reserve0Number)*s*t)-s},s.getLiquidity=function(){return Math.sqrt(this.reserve0Number*this.reserve1Number)},e}(d),f=function(e){function s(r,s,o,i,n,u,a){var c;return(c=e.call(this,r,s,o,i,u,a)||this).A_PRECISION=100,c.A=n,c.D=t.BigNumber.from(0),c}r(s,e);var o=s.prototype;return o.updateReserves=function(e,r){this.D=t.BigNumber.from(0),this.reserve0=e,this.reserve1=r},o.computeLiquidity=function(){if(!this.D.eq(0))return this.D;var e=this.reserve0,r=this.reserve1;if(e.isZero()&&r.isZero())return t.BigNumber.from(0);for(var s,o=e.add(r),i=t.BigNumber.from(2*this.A),n=o,u=0;u<256;u++){var a=n.mul(n).div(e).mul(n).div(r).div(4);if(s=n,(n=i.mul(o).div(this.A_PRECISION).add(a.mul(2)).mul(n).div(i.div(this.A_PRECISION).sub(1).mul(n).add(a.mul(3)))).sub(s).abs().lte(1))break}return this.D=n,n},o.computeY=function(t){for(var e,r=this.computeLiquidity(),s=2*this.A,o=r.mul(r).div(t.mul(2)).mul(r).div(2*s/this.A_PRECISION),i=r.mul(this.A_PRECISION).div(s).add(t),n=r,u=0;u<256&&(e=n,!(n=n.mul(n).add(o).div(n.mul(2).add(i).sub(r))).sub(e).abs().lte(1));u++);return n},o.calcOutByIn=function(t,e){var r=e?this.reserve1:this.reserve0,s=(e?this.reserve0:this.reserve1).add(v(t*(1-this.fee))),o=this.computeY(s);return{out:parseInt(r.sub(o).toString()),gasSpent:this.swapGasCost}},o.calcInByOut=function(e,r){var s=r?this.reserve0:this.reserve1,o=(r?this.reserve1:this.reserve0).sub(v(e));o.lt(1)&&(o=t.BigNumber.from(1));var i=this.computeY(o);return{inp:Math.round(parseInt(i.sub(s).toString())/(1-this.fee)),gasSpent:this.swapGasCost}},o.calcCurrentPriceWithoutFee=function(t){return this.calcPrice(0,t,!1)},o.calcPrice=function(t,e,r){var s=parseInt((e?this.reserve0:this.reserve1).toString()),o=r?1-this.fee:1,i=parseInt(this.computeLiquidity().toString()),n=this.A/this.A_PRECISION,u=s+t,a=4*n*u+i-4*n*i,c=i*i*i/u;return(.5-(2*a-c/u)/Math.sqrt(a*a+4*n*c)/4)*o},o.calcInputByPrice=function(t,e,r,s){var o=this;return void 0===s&&(s=1),h((function(t){return 1/o.calcPrice(t,e,r)}),t,s)},s}(d),g=function(t){function e(e,r,s,o,i,n,u,a,c,h,v){var p;return(p=t.call(this,e,r,s,o,n,u,1e3,4e4)||this).tickSpacing=i,p.liquidity=a,p.sqrtPrice=c,p.nearestTick=h,p.ticks=v,0===p.ticks.length&&(p.ticks.push({index:-887272,DLiquidity:0}),p.ticks.push({index:887271,DLiquidity:0})),p.ticks[0].index>-887272&&p.ticks.unshift({index:-887272,DLiquidity:0}),p.ticks[p.ticks.length-1].index<887271&&p.ticks.push({index:887271,DLiquidity:0}),p}r(e,t);var s=e.prototype;return s.calcOutByIn=function(t,e){for(var r=e?this.nearestTick:this.nearestTick+1,s=this.sqrtPrice,o=this.liquidity,i=0,n=t;n>0;){if(r<0||r>=this.ticks.length)return{out:i,gasSpent:this.swapGasCost};var u=Math.sqrt(Math.pow(1.0001,this.ticks[r].index)),a=0;if(e){var c=o*(s-u)/s/u;n<=c?(a=o*s*n/(n+o/s),n=0):(a=o*(s-u),s=u,n-=c,this.ticks[r].index/this.tickSpacing%2==0?o-=this.ticks[r].DLiquidity:o+=this.ticks[r].DLiquidity,r--)}else{var h=o*(u-s);n<=h?(a=n/s/(s+n/o),n=0):(a=o*(u-s)/s/u,s=u,n-=h,this.ticks[r].index/this.tickSpacing%2==0?o+=this.ticks[r].DLiquidity:o-=this.ticks[r].DLiquidity,r++)}i+=a*(1-this.fee)}return{out:i,gasSpent:this.swapGasCost}},s.calcInByOut=function(t,e){for(var r=e?this.nearestTick:this.nearestTick+1,s=this.sqrtPrice,o=this.liquidity,i=0,n=t/(1-this.fee);n>0;){if(r<0||r>=this.ticks.length)return{inp:i,gasSpent:this.swapGasCost};var u=Math.sqrt(Math.pow(1.0001,this.ticks[r].index));if(e){var a=o*(s-u);n<=a?(i+=n/s/(s-n/o),n=0):(i+=o*(s-u)/s/u,s=u,n-=a,this.ticks[r].index/this.tickSpacing%2==0?o-=this.ticks[r].DLiquidity:o+=this.ticks[r].DLiquidity,r--)}else{var c=o*(u-s)/s/u;n<=c?(i+=o*s*n/(o/s-n),n=0):(i+=o*(u-s),s=u,n-=c,this.ticks[r].index/this.tickSpacing%2==0?o+=this.ticks[r].DLiquidity:o-=this.ticks[r].DLiquidity,r++)}}return{inp:i,gasSpent:this.swapGasCost}},s.calcCurrentPriceWithoutFee=function(t){var e=this.sqrtPrice*this.sqrtPrice;return t?e:1/e},e}(d);(p=exports.RouteStatus||(exports.RouteStatus={})).Success="Success",p.NoWay="NoWay",p.Partial="Partial";var m,P=function(){function t(t,e,r){this.pool=t,this.vert0=e,this.vert1=r,this.amountInPrevious=0,this.amountOutPrevious=0,this.canBeUsed=!0,this.direction=!0,this.spentGas=0,this.spentGasNew=0,this.bestEdgeIncome=0}var e=t.prototype;return e.cleanTmpData=function(){this.amountInPrevious=0,this.amountOutPrevious=0,this.canBeUsed=!0,this.direction=!0,this.spentGas=0,this.spentGasNew=0,this.bestEdgeIncome=0},e.reserve=function(t){return t===this.vert0?this.pool.reserve0:this.pool.reserve1},e.calcOutput=function(t,e){var r,s;if(t===this.vert1)if(this.direction)if(e<this.amountOutPrevious){var o=this.pool.calcInByOut(this.amountOutPrevious-e,!0);r=this.amountInPrevious-o.inp,s=o.gasSpent}else{var i=this.pool.calcOutByIn(e-this.amountOutPrevious,!1);r=i.out+this.amountInPrevious,s=i.gasSpent}else{var n=this.pool.calcOutByIn(this.amountOutPrevious+e,!1);r=n.out-this.amountInPrevious,s=n.gasSpent}else if(this.direction){var u=this.pool.calcOutByIn(this.amountInPrevious+e,!0);r=u.out-this.amountOutPrevious,s=u.gasSpent}else if(e<this.amountInPrevious){var a=this.pool.calcInByOut(this.amountInPrevious-e,!1);r=this.amountOutPrevious-a.inp,s=a.gasSpent}else{var c=this.pool.calcOutByIn(e-this.amountInPrevious,!0);r=c.out+this.amountOutPrevious,s=c.gasSpent}return{out:r,gasSpent:s-this.spentGas}},e.calcInput=function(t,e){var r,s;if(t===this.vert1)if(this.direction){var o=this.pool.calcInByOut(this.amountOutPrevious+e,!0);r=o.inp-this.amountInPrevious,s=o.gasSpent}else if(e<this.amountOutPrevious){var i=this.pool.calcOutByIn(this.amountOutPrevious-e,!1);r=this.amountInPrevious-i.out,s=i.gasSpent}else{var n=this.pool.calcInByOut(e-this.amountOutPrevious,!0);r=n.inp+this.amountInPrevious,s=n.gasSpent}else if(this.direction)if(e<this.amountInPrevious){var u=this.pool.calcOutByIn(this.amountInPrevious-e,!0);r=this.amountOutPrevious-u.out,s=u.gasSpent}else{var a=this.pool.calcInByOut(e-this.amountInPrevious,!1);r=a.inp+this.amountOutPrevious,s=a.gasSpent}else{var c=this.pool.calcInByOut(this.amountInPrevious+e,!1);r=c.inp-this.amountOutPrevious,s=c.gasSpent}return{inp:r,gasSpent:s-this.spentGas}},e.checkMinimalLiquidityExceededAfterSwap=function(t,e){if(t===this.vert0){var r=parseInt(this.pool.reserve1.toString());return this.direction?r-e-this.amountOutPrevious<this.pool.minLiquidity:r-e+this.amountOutPrevious<this.pool.minLiquidity}var s=parseInt(this.pool.reserve0.toString());return this.direction?s-e+this.amountInPrevious<this.pool.minLiquidity:s-e-this.amountInPrevious<this.pool.minLiquidity},e.testApply=function(t,e,r){console.assert(this.amountInPrevious*this.amountOutPrevious>=0);var s,o=this.direction?this.amountInPrevious:-this.amountInPrevious,i=this.direction?this.amountOutPrevious:-this.amountOutPrevious,n=0,u=0;if(t.getNeibour(this)){var a=o+(t===this.vert0?e:-r),h=i+(t===this.vert0?r:-e);a*h<0&&console.log("333"),console.assert(a*h>=0),a>=0?(s=!0,n=a,u=h):(s=!1,n=-a,u=-h)}else console.error("Error 221");if(s){var v=this.pool.calcOutByIn(n,!0).out,p=c(u,v,1e-6);return p||console.log("Err 225-1 !!",u,v,Math.abs(v/u-1)),p}var d=this.pool.calcOutByIn(u,!1).out,l=c(n,d,1e-6);return l||console.log("Err 225-2!!",n,d,Math.abs(d/n-1)),l},e.applySwap=function(t){var e=this;console.assert(this.amountInPrevious*this.amountOutPrevious>=0);var r=this.direction?this.amountInPrevious:-this.amountInPrevious,s=this.direction?this.amountOutPrevious:-this.amountOutPrevious,o=t.getNeibour(this);if(o){var i=r+(t===this.vert0?t.bestIncome:-o.bestIncome),n=s+(t===this.vert0?o.bestIncome:-t.bestIncome);console.assert(i*n>=0),i>=0?(this.direction=!0,this.amountInPrevious=i,this.amountOutPrevious=n):(this.direction=!1,this.amountInPrevious=-i,this.amountOutPrevious=-n)}else console.error("Error 221");this.spentGas=this.spentGasNew,a((function(){return e.direction?c(e.amountOutPrevious,e.pool.calcOutByIn(e.amountInPrevious,e.direction).out,1e-6):c(e.amountInPrevious,e.pool.calcOutByIn(e.amountOutPrevious,e.direction).out,1e-6)}),"Error 225")},t}(),I=function(){function t(t){this.token=t,this.edges=[],this.price=0,this.gasPrice=0,this.bestIncome=0,this.gasSpent=0,this.bestTotal=0,this.bestSource=void 0,this.checkLine=-1}var e=t.prototype;return e.cleanTmpData=function(){this.bestIncome=0,this.gasSpent=0,this.bestTotal=0,this.bestSource=void 0,this.checkLine=-1},e.getNeibour=function(t){if(t)return t.vert0===this?t.vert1:t.vert0},e.getOutputEdges=function(){var t=this;return this.edges.filter((function(e){return!!e.canBeUsed&&0!==e.amountInPrevious&&e.direction===(e.vert0===t)}))},e.getInputEdges=function(){var t=this;return this.edges.filter((function(e){return!!e.canBeUsed&&0!==e.amountInPrevious&&e.direction!==(e.vert0===t)}))},t}(),b=function(){function e(t,e,r){var s=this;this.vertices=[],this.edges=[],this.tokens=new Map,t.forEach((function(t){var e=s.getOrCreateVertice(t.token0),r=s.getOrCreateVertice(t.token1),o=new P(t,e,r);e.edges.push(o),r.edges.push(o),s.edges.push(o)}));var o=this.tokens.get(e.address);o&&this.setPricesStable(o,1,r)}var r=e.prototype;return r.cleanTmpData=function(){this.edges.forEach((function(t){return t.cleanTmpData()})),this.vertices.forEach((function(t){return t.cleanTmpData()}))},r.setPricesStable=function(t,e,r){this.vertices.forEach((function(t){return t.price=0})),t.price=e,t.gasPrice=r;var s=new Map,o=function(t){return s.get(t)};function i(e){var r=e.edges.filter((function(t){var r;return 0==(null==(r=e.getNeibour(t))?void 0:r.price)}));r.forEach((function(r){return s.set(r,e.price*parseInt(r.reserve(t).toString()))})),r.sort((function(t,e){return o(t)-o(e)}));for(var i=[];n.length&&r.length;)o(n[0])<o(r[0])?i.push(n.shift()):i.push(r.shift());n=[].concat(i,n,r)}var n=[];for(i(t);n.length>0;){var u=n.pop(),a=0!==u.vert1.price?[u.vert1,u.vert0]:[u.vert0,u.vert1],c=a[0],h=a[1];if(0===h.price){var v=u.pool.calcCurrentPriceWithoutFee(c===u.vert1);h.price=c.price*v,h.gasPrice=c.gasPrice/v,i(h)}}},r.setPrices=function(t,e,r){var s=this;0===t.price&&(t.price=e,t.gasPrice=r,t.edges.map((function(e){return[e,parseInt(e.reserve(t).toString())]})).sort((function(t,e){return e[1]-t[1]})).forEach((function(o){var i=o[0],n=i.vert0===t?i.vert1:i.vert0;if(0===n.price){var u=i.pool.calcCurrentPriceWithoutFee(t===i.vert1);s.setPrices(n,e*u,r/u)}})))},r.getOrCreateVertice=function(t){var e=this.tokens.get(t.address);return e||(e=new I(t),this.vertices.push(e),this.tokens.set(t.address,e),e)},r.findBestPathExactIn=function(t,e,r,s){var o=this.tokens.get(t.address),i=this.tokens.get(e.address);if(o&&i){var n=void 0!==s?s:i.gasPrice;this.edges.forEach((function(t){t.bestEdgeIncome=0,t.spentGasNew=0})),this.vertices.forEach((function(t){t.bestIncome=0,t.gasSpent=0,t.bestTotal=0,t.bestSource=void 0,t.checkLine=-1})),o.bestIncome=r,o.bestTotal=r;for(var u=new Set,a=[o],c=0,h=function(){var t=void 0,e=void 0,r=0;if(a.forEach((function(s,o){(void 0===e||s.bestTotal>e)&&(e=s.bestTotal,t=s,r=o)})),!t)return{v:void 0};if(t.checkLine=c++,t===i){for(var s=[],o=i;null!=(h=o)&&h.bestSource;o=o.getNeibour(o.bestSource)){var h;s.unshift(o.bestSource)}return{v:{path:s,output:i.bestIncome,gasSpent:i.gasSpent,totalOutput:i.bestTotal}}}a.splice(r,1),t.edges.forEach((function(e){var r=t===e.vert0?e.vert1:e.vert0;if(!u.has(r)){var s,o;try{var c=e.calcOutput(t,t.bestIncome),h=c.out,v=c.gasSpent;if(!isFinite(h)||!isFinite(v))return;s=h,o=v}catch(e){return}if(e.checkMinimalLiquidityExceededAfterSwap(t,s))e.bestEdgeIncome=-1;else{var p=t.gasSpent+o,d=r.price/i.price,l=s*d-p*n;console.assert(0===e.bestEdgeIncome,"Error 373"),e.bestEdgeIncome=s*d,e.spentGasNew=e.spentGas+o,r.bestSource||a.push(r),(!r.bestSource||l>r.bestTotal)&&(r.bestIncome=s,r.gasSpent=p,r.bestTotal=l,r.bestSource=e)}}})),u.add(t)};;){var v=h();if("object"==typeof v)return v.v}}},r.findBestPathExactOut=function(t,e,r,s){var o=this.tokens.get(e.address),i=this.tokens.get(t.address);if(o&&i){var n=void 0!==s?s:i.gasPrice;this.edges.forEach((function(t){t.bestEdgeIncome=0,t.spentGasNew=0})),this.vertices.forEach((function(t){t.bestIncome=0,t.gasSpent=0,t.bestTotal=0,t.bestSource=void 0,t.checkLine=-1})),o.bestIncome=r,o.bestTotal=r;for(var u=new Set,a=[o],c=0,h=function(){var t=void 0,e=void 0,r=0;if(a.forEach((function(s,o){(void 0===e||s.bestTotal<e)&&(e=s.bestTotal,t=s,r=o)})),!t)return{v:void 0};if(t.checkLine=c++,t===i){for(var s=[],o=i;null!=(h=o)&&h.bestSource;o=o.getNeibour(o.bestSource)){var h;s.push(o.bestSource)}return{v:{path:s,input:i.bestIncome,gasSpent:i.gasSpent,totalInput:i.bestTotal}}}a.splice(r,1),t.edges.forEach((function(e){var r=t===e.vert0?e.vert1:e.vert0;if(!u.has(r)){var s,o;try{var c=e.calcInput(t,t.bestIncome),h=c.inp,v=c.gasSpent;if(!isFinite(h)||!isFinite(v))return;if(h<0)return;s=h,o=v}catch(e){return}var p=t.gasSpent+o,d=r.price/i.price,l=s*d+p*n;console.assert(0===e.bestEdgeIncome,"Error 373"),e.bestEdgeIncome=s*d,e.spentGasNew=e.spentGas+o,r.bestSource||a.push(r),(!r.bestSource||l<r.bestTotal)&&(r.bestIncome=s,r.gasSpent=p,r.bestTotal=l,r.bestSource=e)}})),u.add(t)};;){var v=h();if("object"==typeof v)return v.v}}},r.addPath=function(t,e,r){var s=this,o=t;r.forEach((function(t){o?(t.applySwap(o),o=o.getNeibour(t)):console.error("Unexpected 315")})),a((function(){return s.vertices.every((function(r){var s=0,o=0;return r.edges.forEach((function(t){t.vert0===r?(t.direction?s-=t.amountInPrevious:s+=t.amountInPrevious,o+=t.amountInPrevious):(t.direction?s+=t.amountOutPrevious:s-=t.amountOutPrevious,o+=t.amountOutPrevious)})),r===t?s<=0:r===e?s>=0:0===o?0===s:Math.abs(s/o)<1e10}))}),"Error 290")},r.getPrimaryPriceForPath=function(t,e){var r=1,s=t;return e.forEach((function(t){var e=t.pool.calcCurrentPriceWithoutFee(t.vert0===s);r*=e,s=s.getNeibour(t)})),r},r.findBestRouteExactIn=function(e,r,s,o){var i=[];if(Array.isArray(o)){var n=o.reduce((function(t,e){return t+e}),0);i=o.map((function(t){return t/n}))}else for(var u=0;u<o;++u)i.push(1/o);this.edges.forEach((function(t){t.amountInPrevious=0,t.amountOutPrevious=0,t.direction=!0}));var a,c,h,p=0,d=0,l=0;for(c=0;c<i.length;++c){var f=this.findBestPathExactIn(e,r,s*i[c]);if(!f)break;p+=f.output,d+=f.gasSpent,this.addPath(this.tokens.get(e.address),this.tokens.get(r.address),f.path),l+=i[c],0===c&&(a=this.getPrimaryPriceForPath(this.tokens.get(e.address),f.path))}if(0==c)return{status:exports.RouteStatus.NoWay,fromToken:e,toToken:r,amountIn:0,amountInBN:t.BigNumber.from(0),amountOut:0,amountOutBN:t.BigNumber.from(0),legs:[],gasSpent:0,totalAmountOut:0,totalAmountOutBN:t.BigNumber.from(0)};h=c<i.length?exports.RouteStatus.Partial:exports.RouteStatus.Success;var g,m,P=this.tokens.get(e.address),I=this.tokens.get(r.address),b=this.getRouteLegs(P,I),y=b.legs,S=b.gasSpent,O=b.topologyWasChanged;console.assert(S<=d,"Internal Error 491"),O&&(p=this.calcLegsAmountOut(y,s));try{g=p/s,m=void 0!==a?1-g/a:void 0}catch(t){}return{status:h,fromToken:e,toToken:r,primaryPrice:a,swapPrice:g,priceImpact:m,amountIn:s*l,amountInBN:v(s*l),amountOut:p,amountOutBN:v(p),legs:y,gasSpent:S,totalAmountOut:p-S*I.gasPrice,totalAmountOutBN:v(p-S*I.gasPrice)}},r.findBestRouteExactOut=function(e,r,s,o){var i=[];if(Array.isArray(o)){var n=o.reduce((function(t,e){return t+e}),0);i=o.map((function(t){return t/n}))}else for(var u=0;u<o;++u)i.push(1/o);this.edges.forEach((function(t){t.amountInPrevious=0,t.amountOutPrevious=0,t.direction=!0}));var a,c,h,p=0,d=0,l=0;for(c=0;c<i.length;++c){var f=this.findBestPathExactOut(e,r,s*i[c]);if(!f)break;p+=f.input,d+=f.gasSpent,this.addPath(this.tokens.get(e.address),this.tokens.get(r.address),f.path),l+=i[c],0===c&&(a=this.getPrimaryPriceForPath(this.tokens.get(e.address),f.path))}if(0==c)return{status:exports.RouteStatus.NoWay,fromToken:e,toToken:r,amountIn:0,amountInBN:t.BigNumber.from(0),amountOut:0,amountOutBN:t.BigNumber.from(0),legs:[],gasSpent:0,totalAmountOut:0,totalAmountOutBN:t.BigNumber.from(0)};h=c<i.length?exports.RouteStatus.Partial:exports.RouteStatus.Success;var g,m,P=this.tokens.get(e.address),I=this.tokens.get(r.address),b=this.getRouteLegs(P,I),y=b.legs,S=b.gasSpent,O=b.topologyWasChanged;console.assert(S<=d,"Internal Error 491"),O&&(p=this.calcLegsAmountIn(y,s));try{g=s/p,m=void 0!==a?1-g/a:void 0}catch(t){}return{status:h,fromToken:e,toToken:r,primaryPrice:a,swapPrice:g,priceImpact:m,amountIn:p,amountInBN:v(p),amountOut:s*l,amountOutBN:v(s*l),legs:y,gasSpent:S,totalAmountOut:s-S*I.gasPrice,totalAmountOutBN:v(s-S*I.gasPrice)}},r.getRouteLegs=function(t,e){var r=this,s=this.cleanTopology(t,e),o=s.topologyWasChanged,i=[],n=0;return s.vertices.forEach((function(t){var e=t.getOutputEdges().map((function(t){var e=r.edgeFrom(t);return e?[t,e.vert,e.amount]:[t]})),s=e.reduce((function(t,e){return t+e[2]}),0);if(!(s<=0)){var o=s;e.forEach((function(r,u){var a=r[2],c=u+1===e.length?1:a/s,h=r[0];i.push({poolAddress:h.pool.address,poolFee:h.pool.fee,tokenFrom:t.token,tokenTo:t.getNeibour(h).token,assumedAmountIn:h.direction?h.amountInPrevious:h.amountOutPrevious,assumedAmountOut:h.direction?h.amountOutPrevious:h.amountInPrevious,swapPortion:c,absolutePortion:a/o}),n+=r[0].pool.swapGasCost,s-=a})),console.assert(s/o<1e-12,"Error 281")}})),{legs:i,gasSpent:n,topologyWasChanged:o}},r.edgeFrom=function(t){if(0!==t.amountInPrevious)return t.direction?{vert:t.vert0,amount:t.amountInPrevious}:{vert:t.vert1,amount:t.amountOutPrevious}},r.calcLegsAmountOut=function(t,e){var r=this,s=new Map;return s.set(t[0].tokenFrom.address,e),t.forEach((function(t){var e=r.tokens.get(t.tokenFrom.address);console.assert(void 0!==e,"Internal Error 570");var o=e.edges.find((function(e){return e.pool.address===t.poolAddress}));console.assert(void 0!==o,"Internel Error 569");var i=o.pool,n=e===o.vert0,u=s.get(t.tokenFrom.address);console.assert(void 0!==u,"Internal Error 564");var a=u*t.swapPortion;s.set(t.tokenFrom.address,u-a);var c=i.calcOutByIn(a,n).out,h=e.getNeibour(o),v=s.get(h.token.address);s.set(h.token.address,(v||0)+c)})),s.get(t[t.length-1].tokenTo.address)||0},r.calcLegsAmountIn=function(t,e){var r=this,s=new Map;t.forEach((function(t){var e=s.get(t.tokenFrom.address)||0;s.set(t.tokenFrom.address,e+t.assumedAmountOut)}));var o=new Map;o.set(t[t.length-1].tokenTo.address,e);for(var i=function(e){var i=t[e],n=r.tokens.get(i.tokenTo.address);console.assert(void 0!==n,"Internal Error 884");var u=n.edges.find((function(t){return t.pool.address===i.poolAddress}));console.assert(void 0!==u,"Internel Error 888");var a=u.pool,c=n===u.vert1,h=o.get(i.tokenTo.address);console.assert(void 0!==h,"Internal Error 893");var v=s.get(i.tokenFrom.address);console.assert(void 0!==v,"Internal Error 903");var p=a.calcInByOut(h*i.assumedAmountOut/v,c).inp,d=n.getNeibour(u),l=o.get(d.token.address);o.set(d.token.address,(l||0)+p)},n=t.length-1;n>=0;--n)i(n);return o.get(t[0].tokenFrom.address)||0},r.cleanTopology=function(t,e){var r=!1,s=this.topologySort(t,e);if(2!==s.status){for(r=!0,console.assert(0===s.status,"Internal Error 554");0===s.status;)this.removeWeakestEdge(s.vertices),s=this.topologySort(t,e);if(3===s.status&&(this.removeDeadEnds(s.vertices),s=this.topologySort(t,e)),console.assert(2===s.status,"Internal Error 563"),2!==s.status)return{vertices:[],topologyWasChanged:r}}return{vertices:s.vertices,topologyWasChanged:r}},r.removeDeadEnds=function(t){t.forEach((function(t){t.getInputEdges().forEach((function(t){t.canBeUsed=!1}))}))},r.removeWeakestEdge=function(t){var e,r,s=Number.MAX_VALUE;t.forEach((function(o,i){var n=0===i?t[t.length-1]:t[i-1],u=0;o.getOutputEdges().forEach((function(t){o.getNeibour(t)===n&&(u+=t.direction?t.amountOutPrevious:t.amountInPrevious)})),u<s&&(e=o,r=n,s=u)})),e.getOutputEdges().forEach((function(t){e.getNeibour(t)===r&&(t.canBeUsed=!1)}))},r.topologySort=function(t,e){var r=new Map,s=[],o=[],i=[],n=function t(n){var u=r.get(n);if(2===u||3===u)return u;if(1===u)return console.assert(0==o.length,"Internal Error 566"),o.push(n),1;r.set(n,1);for(var a=!1,c=n.getOutputEdges(),h=0;h<c.length;++h){var v=t(n.getNeibour(c[h]));if(0===v)return 0;if(1===v)return o[0]===n?0:(o.push(n),1);2===v&&(a=!0)}return a?(console.assert(n!==e,"Internal Error 589"),s.push(n),r.set(n,2),2):n!==e?(i.push(n),r.set(n,3),3):(s.push(n),r.set(n,2),2)}(t);return 0===n?{status:0,vertices:o}:i.length?{status:3,vertices:i}:(a((function(){return s[0]===e&&s[s.length-1]===t}),"Internal Error 614"),2===n?{status:2,vertices:s.reverse()}:(console.assert(!0,"Internal Error 612"),{status:1,vertices:[]}))},e}();function y(t,e,r){var s=function(t){if(void 0!==t.primaryPrice&&void 0!==t.swapPrice){var e=1;return t.legs.forEach((function(t){return e*=1-t.poolFee})),Math.max(0,1-t.swapPrice/t.primaryPrice/e)}}(t);if(!s)return 12;var o=Math.sqrt(t.gasSpent*(r||0)*e/s),i=Math.round(e/o);return isFinite(i)?Math.max(1,Math.min(i,100)):12}(m=exports.PoolType||(exports.PoolType={})).ConstantProduct="ConstantProduct",m.Weighted="Weighted",m.Hybrid="Hybrid",m.ConcentratedLiquidity="ConcentratedLiquidity";var S=function(t){var r=e({minLiquidity:1e3,swapGasCost:4e4},t);this.address=r.address,this.token0=r.token0,this.token1=r.token1,this.type=r.type,this.reserve0=r.reserve0,this.reserve1=r.reserve1,this.fee=r.fee,this.minLiquidity=r.minLiquidity,this.swapGasCost=r.swapGasCost},O=function(t){function s(r){return t.call(this,e({type:exports.PoolType.ConstantProduct},r))||this}return r(s,t),s}(S),k=function(t){function s(r){var s;return(s=t.call(this,e({type:exports.PoolType.Hybrid},r))||this).A=r.A,s}return r(s,t),s}(S),x=function(t){function s(r){var s;return(s=t.call(this,e({type:exports.PoolType.Weighted},r))||this).weight0=r.weight0,s.weight1=r.weight1,s}return r(s,t),s}(S),E=function(s){function o(r){var o;return(o=s.call(this,e({type:exports.PoolType.ConcentratedLiquidity,reserve0:t.BigNumber.from(0),reserve1:t.BigNumber.from(0)},r))||this).liquidity=r.liquidity,o.sqrtPrice=r.sqrtPrice,o.nearestTick=r.nearestTick,o.ticks=r.ticks,o}return r(o,s),o}(S),N=new Map;function B(e){var r=N.get(e);if(void 0!==r)return r;var s=e.reserve0,o=e.reserve1;if(s.isZero()&&o.isZero())return N.set(e,t.BigNumber.from(0)),t.BigNumber.from(0);for(var i,n=s.add(o),u=t.BigNumber.from(2*e.A),a=n,c=0;c<256;c++){var h=a.mul(a).div(s).mul(a).div(o).div(4);if(i=a,(a=u.mul(n).div(100).add(h.mul(2)).mul(a).div(u.div(100).sub(1).mul(a).add(h.mul(3)))).sub(i).abs().lte(1))break}return N.set(e,a),a}function w(t,e){for(var r,s=B(t),o=2*t.A,i=s.mul(s).div(e.mul(2)).mul(s).div(2*o/100),n=s.mul(100).div(o).add(e),u=s,a=0;a<256&&(r=u,!(u=u.mul(u).add(i).div(u.mul(2).add(n).sub(s))).sub(r).abs().lte(1));a++);return u}var T=function(t){function e(){return t.apply(this,arguments)||this}return r(e,t),e}(u(Error));function R(t,e,r){void 0===r&&(r=!0);var s=parseInt(t.reserve0.toString()),o=parseInt(t.reserve1.toString()),i=r?1-t.fee:1;switch(t.type){case exports.PoolType.ConstantProduct:var n=s/i;return o*n/(n+e)/(n+e);case exports.PoolType.Weighted:var u=t.weight0/t.weight1,a=s+e*i;return o*u*i*Math.pow(s/a,u)/a;case exports.PoolType.Hybrid:var c=t,h=parseInt(B(c).toString()),v=c.A/100,p=s+e,d=4*v*p+h-4*v*h,l=h*h*h/p;return(.5-(2*d-l/p)/Math.sqrt(d*d+4*v*l)/4)*i}return 0}exports.ASSERT=a,exports.CLRPool=g,exports.CL_MAX_TICK=887271,exports.CL_MIN_TICK=-887272,exports.ConstantProductRPool=l,exports.Edge=P,exports.Graph=b,exports.HybridComputeLiquidity=B,exports.HybridRPool=f,exports.HybridgetY=w,exports.OutOfLiquidity=T,exports.Pool=S,exports.RConcentratedLiquidityPool=E,exports.RConstantProductPool=O,exports.RHybridPool=k,exports.RPool=d,exports.RWeightedPool=x,exports.TYPICAL_MINIMAL_LIQUIDITY=1e3,exports.TYPICAL_SWAP_GAS_COST=4e4,exports.Vertice=I,exports.calcInByOut=function(e,r,s){var o=0,i=s?e.reserve0:e.reserve1,n=s?e.reserve1:e.reserve0;switch(e.type){case exports.PoolType.ConstantProduct:var u=parseInt(i.toString()),a=parseInt(n.toString());o=u*r/(1-e.fee)/(a-r);break;case exports.PoolType.Weighted:var c=parseInt(i.toString()),h=parseInt(n.toString());o=c*(1-e.fee)*(Math.pow(1-r/h,-(s?e.weight0/e.weight1:e.weight1/e.weight0))-1);break;case exports.PoolType.Hybrid:var p=n.sub(v(r));p.lt(1)&&(p=t.BigNumber.from(1));var d=w(e,p);o=Math.round(parseInt(d.sub(i).toString())/(1-e.fee));break;default:console.error("Unknown pool type")}return o<1&&(o=1),o},exports.calcInputByPrice=function(t,e,r){switch(void 0===r&&(r=1),t.type){case exports.PoolType.ConstantProduct:var s=parseInt(t.reserve0.toString()),o=parseInt(t.reserve1.toString()),i=s/(1-t.fee);return Math.sqrt(o*i*e)-i;case exports.PoolType.Weighted:return function(t,e){var r=parseInt(t.reserve0.toString()),s=parseInt(t.reserve1.toString()),o=t.weight0/t.weight1,i=s*e*o*(1-t.fee)*Math.pow(r,o);return(Math.pow(i,1/(o+1))-r)/(1-t.fee)}(t,e);case exports.PoolType.Hybrid:return h((function(e){return 1/R(t,e)}),e,r)}return 0},exports.calcOutByIn=function(t,e,r){void 0===r&&(r=!0);var s=r?t.reserve0:t.reserve1,o=r?t.reserve1:t.reserve0;switch(t.type){case exports.PoolType.ConstantProduct:var i=parseInt(s.toString());return parseInt(o.toString())*e/(i/(1-t.fee)+e);case exports.PoolType.Weighted:var n=parseInt(s.toString());return parseInt(o.toString())*(1-Math.pow(n/(n+e*(1-t.fee)),r?t.weight0/t.weight1:t.weight1/t.weight0));case exports.PoolType.Hybrid:var u=w(t,s.add(v(e*(1-t.fee))));return parseInt(o.sub(u).toString())}return-1},exports.calcPrice=R,exports.calcSquareEquation=function(t,e,r){var s=e*e-4*t*r;console.assert(s>=0,"Discriminant is negative! "+t+" "+e+" "+r);var o=Math.sqrt(s);return[(-e-o)/2/t,(-e+o)/2/t]},exports.calcTokenPrices=function(t,e){var r=new b(t,e,0),s=new Map;return r.vertices.forEach((function(t){return s.set(t.token,t.price)})),s},exports.closeValues=c,exports.findMultiRouteExactIn=function(e,r,s,o,i,n,u){s instanceof t.BigNumber&&(s=parseInt(s.toString()));var a=new b(o,i,n),c=a.tokens.get(e.address);if(0===(null==c?void 0:c.price)&&a.setPricesStable(c,1,0),void 0!==u)return a.findBestRouteExactIn(e,r,s,u);var h=a.findBestRouteExactIn(e,r,s,1);a.cleanTmpData();var v,p,d=y(h,s,null==c?void 0:c.gasPrice);return 1===d?h:(p=a.findBestRouteExactIn(e,r,s,d),(v=h).status==exports.RouteStatus.NoWay?p:p.status==exports.RouteStatus.NoWay?v:v.status==exports.RouteStatus.Partial&&p.status==exports.RouteStatus.Success?p:p.status==exports.RouteStatus.Partial&&v.status==exports.RouteStatus.Success||v.totalAmountOut>p.totalAmountOut?v:p)},exports.findMultiRouteExactOut=function(e,r,s,o,i,n,u){s instanceof t.BigNumber&&(s=parseInt(s.toString()));var a=new b(o,i,n),c=a.tokens.get(e.address);if(0===(null==c?void 0:c.price)&&a.setPricesStable(c,1,0),void 0!==u)return a.findBestRouteExactOut(e,r,s,u);var h=a.findBestRouteExactOut(e,r,s,1);a.cleanTmpData();var v=y(h,h.amountIn,null==c?void 0:c.gasPrice);return 1===v?h:function(t,e,r){return t.status==exports.RouteStatus.NoWay?e:e.status==exports.RouteStatus.NoWay?t:t.status==exports.RouteStatus.Partial&&e.status==exports.RouteStatus.Success?e:e.status==exports.RouteStatus.Partial&&t.status==exports.RouteStatus.Success||t.amountIn+t.gasSpent*r<e.amountIn+e.gasSpent*r?t:e}(h,a.findBestRouteExactOut(e,r,s,v),n)},exports.findSingleRouteExactIn=function(e,r,s,o,i,n){var u=new b(o,i,n),a=u.tokens.get(e.address);return 0===(null==a?void 0:a.price)&&u.setPricesStable(a,1,0),s instanceof t.BigNumber&&(s=parseInt(s.toString())),u.findBestRouteExactIn(e,r,s,1)},exports.findSingleRouteExactOut=function(e,r,s,o,i,n){var u=new b(o,i,n),a=u.tokens.get(e.address);return 0===(null==a?void 0:a.price)&&u.setPricesStable(a,1,0),s instanceof t.BigNumber&&(s=parseInt(s.toString())),u.findBestRouteExactOut(e,r,s,1)},exports.getBigNumber=v,exports.revertPositive=h;
//# sourceMappingURL=castle.cjs.production.min.js.map
